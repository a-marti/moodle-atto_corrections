YUI.add("moodle-atto_corrections-button",function(s,t){var r="atto_corrections",a={FORM:"atto_formcorrections",SPAN:"atto_corrections",CORRSPAN:"atto_corrections_correction",CORRTEXT:"atto_corrections_comment",BASECLASS:"atto_corrections_",SELECT:"atto_corrections_select",TEXTAREA:"atto_corrections_textarea",FULLTEXT:"atto_corrections_fulltext"},c={SPAN:"."+a.SPAN,SELECT:"."+a.SELECT,TEXTAREA:"."+a.TEXTAREA},e='<form class="atto_form {{CSS.FORM}}"><label for="{{elementid}}_atto_corrections_corrtype">{{get_string "corrtype" component}}</label><select id="{{elementid}}_atto_corrections_corrtype" class="{{CSS.SELECT}}">{{#each corrtypes}}<option value="{{{abbr}}}">{{{descr}}}</option>{{/each}}</select><label for="{{elementid}}_atto_corrections_corrtext">{{get_string "corrtext" component}}</label><textarea class="fullwidth {{CSS.TEXTAREA}}" type="text" id="{{elementid}}_atto_corrections_corrtext"></textarea><div class="mdl-align"><br/><button class="submit" type="submit">{{get_string "addcomment" component}}</button></div></form>',o='<div class="{{CSS.FULLTEXT}}">{{fulltext}}</div>';s.namespace("M.atto_corrections").Button=s.Base.create("button",s.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_isoncorr:null,initializer:function(){var e,o;this.get("disabled")||(e=[],o=0,s.Array.each(this.get("corrtypes"),function(t){e.push({text:t.descr,callbackArgs:new Array(o,t.descr)}),o++}),this.addToolbarMenu({icon:M.util.image_url("icon1",r),globalItemConfig:{callback:this._addCorrection},items:e,buttonName:"corrections1",title:"addmark"}),this.addButton({icon:M.util.image_url("icon2",r),callback:this._removeCorrection,tags:c.SPAN,buttonName:"corrections2",title:"removemark"}),this.addButton({icon:M.util.image_url("icon3",r),callback:this._displayFulltext,buttonName:"corrections3",title:"displayfulltext"}),this.get("host").on("pluginsloaded",function(){this.get("host").on("atto:selectionchanged",this._updateButtonsStates,this)},this),this._updateButtonsStates())},_addCorrection:function(t,e){var o;this._currentSelection=this.get("host").getSelection(),!1===this._currentSelection||this._currentSelection.collapsed||(o=this.get("host").getSelectionParentNode())&&this._displayDialogue(e,o)},_removeCorrection:function(t){t.preventDefault();t=this.get("host").getSelectionParentNode().parentNode;"span"===t.nodeName.toLowerCase()&&-1!==t.className.indexOf(a.SPAN)&&(s.Node(t).one("."+a.CORRSPAN).remove(),t.parentNode.replaceChild(document.createTextNode(t.innerHTML),t))},_displayFulltext:function(){var t=this.getDialogue({headerContent:M.util.get_string("fulltexttitle",r),focusAfterHide:!0,width:600}),e=s.Handlebars.compile(o),e=s.Node.create(e({component:r,CSS:a,fulltext:new s.Handlebars.SafeString(this.get("host").editor.getHTML())}));t.set("bodyContent",e).show()},_displayDialogue:function(t,e){var o,n;nnnn=e,n=o=!1,this._isoncorr&&(o=e.parentNode.className.replace(a.SPAN+" "+a.BASECLASS,"").replace(" ",""),n=s.Node(e.parentNode).one(".atto_corrections_comment").getDOMNode().innerHTML),this.getDialogue({headerContent:M.util.get_string("dialogtitle",r),focusAfterHide:!0,focusOnShowSelector:c.TEXTAREA}).set("bodyContent",this._getDialogueContent()).show(),this._isoncorr?(s.one(".atto_form."+a.FORM+" select").set("selectedIndex",this.get("corrtypekeys").indexOf(o)),s.one(".atto_form."+a.FORM+" textarea").set("value",n)):s.one(".atto_form."+a.FORM+" select").set("selectedIndex",t[0])},_getDialogueContent:function(){var t=s.Handlebars.compile(e);return this._content=s.Node.create(t({component:r,elementid:this.get("host").get("elementid"),CSS:a,corrtypes:this.get("corrtypes")})),this._content.one(".submit").on("click",this._setCorrection,this),this._content},_setCorrection:function(t){var e,o,n,r,i;t.preventDefault(),this.getDialogue({focusAfterHide:this._currentSelection}).hide(),i=(e=t.currentTarget.ancestor(".atto_form")).one(c.SELECT).get("value"),o=e.one(c.TEXTAREA).get("value"),t=this.get("host"),ffff=e,""!==i&&(t.setSelection(this._currentSelection),this._isoncorr?((r=s.Node(t.getSelectionParentNode().parentNode)).one("."+a.CORRTEXT).getDOMNode().innerHTML=o,n=a.SPAN+" "+a.BASECLASS+i,r.one("."+a.CORRTEXT).getDOMNode().parentNode.parentNode.className=n,r.one("sup").getDOMNode().innerHTML=i):(n="ts"+(new Date).getTime(),t.toggleInlineSelectionClass([a.SPAN]),t.toggleInlineSelectionClass([a.BASECLASS+i]),t.toggleInlineSelectionClass([n]),r=s.Node.create('<span class="'+a.CORRSPAN+'"/>'),t=s.Node.create('<span class="'+a.CORRTEXT+'">'+o+"</span>"),i=s.Node.create('<sup title="'+o+'">'+i+"</sup>"),s.one("."+n).appendChild(r),s.one("."+n).removeClass(n),r.appendChild(i.getDOMNode()),r.appendChild(t.getDOMNode())),this.markUpdated())},_updateButtonsStates:function(){var t=this.get("host").getSelectionParentNode().parentNode,e=rangy.getSelection();if(!e.rangeCount)return this.disableButtons("corrections1"),void this.disableButtons("corrections2");e=e.getRangeAt(0),this._isoncorr="span"===t.nodeName.toLowerCase()&&-1!==t.className.indexOf(a.SPAN),this._isoncorr?this.enableButtons("corrections2"):this.disableButtons("corrections2"),e.collapsed&&!this._isoncorr||!e.collapsed&&this._isoncorr?this.disableButtons("corrections1"):this.enableButtons("corrections1")}},{ATTRS:{disabled:{value:!1},corrtypes:{value:{}},corrtypekeys:{value:{}}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});